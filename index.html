<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>لوحة تحكم مراجعة حفظ القرآن</title>

  <!-- مكتبة Supabase يجب أن تُحمَّل أولاً -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f7f9fc;margin:20px;direction:rtl}
    h1{text-align:center;color:#2c3e50;margin-bottom:20px}
    #levelStatsContainer{max-width:600px;margin:0 auto 30px;background:#fff;padding:15px;border-radius:10px;box-shadow:inset 0 0 10px #3498db;font-weight:bold}
    .level-row{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .level-label{min-width:120px;text-align:right;color:#444;font-weight:bold}
    .level-percentage{height:25px;border-radius:12px;background:#ddd;flex-grow:1;margin:0 10px;position:relative}
    .level-fill{height:100%;border-radius:12px;color:#fff;font-weight:bold;text-align:right;padding-right:10px;line-height:25px;transition:width .5s;width:0}
    .level-count{width:130px;text-align:left;color:#222;white-space:nowrap}
    table{border-collapse:collapse;width:100%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-top:40px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#3498db;color:#fff}
    td[contenteditable="true"]{background:#ecf0f1;cursor:text}
    button{background:#2980b9;color:#fff;border:none;padding:10px 15px;margin:15px auto;cursor:pointer;border-radius:5px;font-size:16px;display:block;width:210px;transition:.3s}
    button:hover{background:#1c5980}
    .container{max-width:1200px;margin:auto}
  </style>
</head>
<body>
  <div class="container">
    <h1>لوحة تحكم لمراجعة حفظ القرآن الكريم</h1>
    <div id="levelStatsContainer"></div>
    <button onclick="addColumn()">إضافة عمود مراجعة جديد</button>
    <button onclick="saveToSupabase()">حفظ على السحابة</button>
    <button onclick="loadFromSupabase()">استرجاع من السحابة</button>

    <table id="quranTable">
      <thead>
        <tr>
          <th>رقم السورة</th>
          <th>اسم السورة</th>
          <th>مستوى الحفظ</th>
          <th>تاريخ المراجعة 1</th>
          <th>تاريخ المراجعة 2</th>
          <th>تاريخ المراجعة 3</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    /* 1- تهيئة Supabase بعد تحميل المكتبة مباشرة */
    const supabaseUrl  = 'https://ltefkkgtncxasvpncdrx.supabase.co';
    const supabaseKey  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0ZWZra2d0bmN4YXN2cG5jZHJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NjM2NDIsImV4cCI6MjA3MzQzOTY0Mn0.wtSPDJhDWINqxyMF0c1jwiqCbfAjzlSXoFS-Ay';
    const supabase     = supabase.createClient(supabaseUrl, supabaseKey);

    /* 2- بيانات السور */
    const surahs=[ 'الفاتحة','البقرة','آل عمران','النساء','المائدة','الأنعام','الأعراف','الأنفال','التوبة','يونس',
      'هود','يوسف','الرعد','إبراهيم','الحجر','النحل','الإسراء','الكهف','مريم','طه','الأنبياء','الحج','المؤمنون',
      'النور','الفرقان','الشعراء','النمل','القصص','العنكبوت','الروم','لقمان','السجدة','الأحزاب','سبأ','فاطر','يس',
      'الصافات','ص','الزمر','غافر','فصلت','الشورى','الزخرف','الدخان','الجاثية','الأحقاف','محمد','الفتح','الحجرات',
      'ق','الذاريات','الطور','النجم','القمر','الرحمن','الواقعة','الحديد','المجادلة','الحشر','الممتحنة','الصف',
      'الجمعة','المنافقون','التغابن','الطلاق','التحريم','الملك','القلم','الحاقة','المعارج','نوح','الجن','المزمل',
      'المدثر','القيامة','الإنسان','المرسلات','النبأ','النازعات','عبس','التكوير','الإنفطار','المطففين','الإنشقاق',
      'البروج','الطارق','الأعلى','الغاشية','الفجر','البلد','الشمس','الليل','الضحى','الشرح','التين','العلق','القدر',
      'البينة','الزلزلة','العاديات','القارعة','التكاثر','العصر','الهمزة','الفيل','قريش','الماعون','الكوثر',
      'الكافرون','النصر','المسد','الإخلاص','الفلق','الناس' ];

    /* عناصر DOM */
    const tbody=document.querySelector('#quranTable tbody');
    const levelStatsContainer=document.getElementById('levelStatsContainer');

    /* debounce مساعد */
    const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};

    /* رسم السور */
    function loadSurahs(){
      surahs.forEach((s,index)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${index+1}</td>
          <td>${s}</td>
          <td>
            <select id="level-${index}">
              <option value="">اختر المستوى</option>
              <option value="1">ضعيف</option>
              <option value="2">متوسط</option>
              <option value="3">جيد</option>
              <option value="4">ممتاز</option>
            </select>
          </td>
          <td contenteditable="true" id="review1-${index}"></td>
          <td contenteditable="true" id="review2-${index}"></td>
          <td contenteditable="true" id="review3-${index}"></td>`;
        tbody.appendChild(tr);

        /* أحداث التغيير */
        tr.querySelector('select').addEventListener('change',()=>{saveState(index);updateLevelStats();});
        [3,4,5].forEach(i=>{
          tr.cells[i].addEventListener('input',debounce(()=>saveReviewDate(index,i-2,tr.cells[i]),500));
        });
      });
      restoreState();            /* من localStorage */
      updateLevelStats();        /* رسم الإحصاء */
    }

    /* تخزين محلي */
    const saveState = i=>localStorage.setItem(`level-${i}`,document.getElementById(`level-${i}`).value);
    const saveReviewDate=(i,col,el)=>localStorage.setItem(`review-${i}-${col}`,el.textContent.trim());

    function restoreState(){
      surahs.forEach((_,i)=>{
        const lvl=localStorage.getItem(`level-${i}`); if(lvl) document.getElementById(`level-${i}`).value=lvl;
        [1,2,3].forEach(c=>{
          const d=localStorage.getItem(`review-${i}-${c}`); if(d) tbody.children[i].cells[c+2].textContent=d;
        });
      });
    }

    /* إحصاء المستويات */
    function updateLevelStats(){
      const counts={1:0,2:0,3:0,4:0}; let total=0;
      tbody.querySelectorAll('select').forEach(sel=>{
        if(sel.value){counts[sel.value]++;total++;}
      });
      if(!total){levelStatsContainer.innerHTML='<em>لم يتم تعيين مستويات الحفظ بعد.</em>';return;}
      const colors={1:'#e74c3c',2:'#f39c12',3:'#2980b9',4:'#27ae60'};
      const names ={1:'ضعيف',2:'متوسط',3:'جيد',4:'ممتاز'};
      levelStatsContainer.innerHTML=['1','2','3','4'].map(l=>{
        const p=((counts[l]/total)*100).toFixed(1);
        const t=counts[l]===1?'1 سورة':`${counts[l]} سور`;
        return`<div class="level-row">
          <span class="level-label">${names[l]}</span>
          <div class="level-percentage">
            <div class="level-fill" style="background:${colors[l]};width:${p}%;">${p}%</div>
          </div>
          <span class="level-count">${t}</span>
        </div>`;
      }).join('');
    }

    /* Supabase: حفظ / تحميل */
    async function saveToSupabase(){
      const dataObj={};
      surahs.forEach((_,i)=>{
        dataObj[i]={ level:document.getElementById(`level-${i}`).value,
          review1:document.getElementById(`review1-${i}`).textContent,
          review2:document.getElementById(`review2-${i}`).textContent,
          review3:document.getElementById(`review3-${i}`).textContent };
      });
      const {error}=await supabase.from('quran_review').upsert([{id:'user1',data:dataObj}],{onConflict:'id'});
      alert(error?'حدث خطأ في الحفظ':'تم الحفظ على السحابة');
    }

    async function loadFromSupabase(){
      const {data,error}=await supabase.from('quran_review').select('*').eq('id','user1');
      if(error||!data.length)return;
      const userData=data[0].data;
      Object.keys(userData).forEach(i=>{
        const d=userData[i];
        document.getElementById(`level-${i}`).value=d.level||'';
        document.getElementById(`review1-${i}`).textContent=d.review1||'';
        document.getElementById(`review2-${i}`).textContent=d.review2||'';
        document.getElementById(`review3-${i}`).textContent=d.review3||'';
      });
      updateLevelStats();
      alert('تم الاسترجاع من السحابة');
    }

    /* إضافة عمود مراجعة جديد */
    function addColumn(){
      const headRow=document.querySelector('#quranTable thead tr');
      const newIdx=headRow.cells.length-2;
      const th=document.createElement('th');th.textContent=`تاريخ المراجعة ${newIdx}`;headRow.appendChild(th);
      tbody.querySelectorAll('tr').forEach((tr,i)=>{
        const td=document.createElement('td');td.contentEditable=true;
        td.addEventListener('input',debounce(()=>saveReviewDate(i,newIdx,td),500));tr.appendChild(td);
      });
    }

    /* تحميل الصفحة */
    window.onload=()=>{loadSurahs();loadFromSupabase();};
  </script>
</body>
</html>
