<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم مراجعة حفظ القرآن مع Supabase وقاعدة بيانات</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f7f9fc; margin: 20px; padding: 0; direction: rtl; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        #levelStatsContainer { max-width: 600px; margin: 0 auto 30px auto; background: #ffffff; padding: 15px; border-radius: 10px; box-shadow: inset 0 0 10px #3498db; font-weight: bold; }
        .level-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; max-width: 100%; }
        .level-label { min-width: 120px; text-align: right; color: #444; font-weight: bold; }
        .level-percentage { height: 25px; border-radius: 12px; background: #ddd; flex-grow: 1; margin: 0 10px; position: relative; }
        .level-fill { height: 100%; border-radius: 12px; color: white; font-weight: bold; text-align: right; padding-right: 10px; line-height: 25px; transition: width 0.5s ease; width: 0%; }
        .level-count { width: 130px; text-align: left; font-weight: normal; color: #222; white-space: nowrap; }
        table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 40px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #3498db; color: white; }
        td[contenteditable="true"] { background-color: #ecf0f1; cursor: text; }
        button { background-color: #2980b9; color: white; border: none; padding: 10px 15px; margin: 15px auto; cursor: pointer; border-radius: 5px; font-size: 16px; display: block; width: 210px; transition: background-color 0.3s ease; }
        button:hover { background-color: #1c5980; }
        .container { max-width: 1200px; margin: auto; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>لوحة تحكم لمراجعة حفظ القرآن الكريم</h1>
        <div id="levelStatsContainer"></div>
        <button onclick="addColumn()">إضافة عمود مراجعة جديد</button>
        <button onclick="saveToSupabase()">حفظ على السحابة</button>
        <button onclick="loadFromSupabase()">استرجاع من السحابة</button>
        <table id="quranTable">
            <thead>
                <tr>
                    <th>رقم السورة</th>
                    <th>اسم السورة</th>
                    <th>مستوى الحفظ</th>
                    <th>تاريخ المراجعة 1</th>
                    <th>تاريخ المراجعة 2</th>
                    <th>تاريخ المراجعة 3</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
      // إعداد Supabase
      const supabaseUrl = 'https://ltefkkgtncxasvpncdrx.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0ZWZra2d0bmN4YXN2cG5jZHJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NjM2NDIsImV4cCI6MjA3MzQzOTY0Mn0.wtSPDJhDWINqxyMF0c1jwiqCbfAjzlSXoFS-Ay';
      let supabase;
      try {
          supabase = supabase.createClient(supabaseUrl, supabaseKey);
      } catch (e) {
          console.error('خطأ في تهيئة Supabase:', e);
          alert('خطأ في الاتصال بقاعدة البيانات. تحقق من الـ URL والمفتاح.');
      }

      const surahs = [
          'الفاتحة', 'البقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف', 'الأنفال', 'التوبة', 'يونس',
          'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر', 'النحل', 'الإسراء', 'الكهف', 'مريم', 'طه',
          'الأنبياء', 'الحج', 'المؤمنون', 'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت', 'الروم',
          'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص', 'الزمر', 'غافر',
          'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية', 'الأحقاف', 'محمد', 'الفتح', 'الحجرات', 'ق',
          'الذاريات', 'الطور', 'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر', 'الممتحنة',
          'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم', 'الملك', 'القلم', 'الحاقة', 'المعارج',
          'نوح', 'الجن', 'المزمل', 'المدثر', 'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات', 'عبس',
          'التكوير', 'الإنفطار', 'المطففين', 'الإنشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية', 'الفجر', 'البلد',
          'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق', 'القدر', 'البينة', 'الزلزلة', 'العاديات',
          'القارعة', 'التكاثر', 'العصر', 'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون', 'النصر',
          'المسد', 'الإخلاص', 'الفلق', 'الناس'
      ];

      const tbody = document.querySelector('#quranTable tbody');
      const levelStatsContainer = document.getElementById('levelStatsContainer');

      function debounce(func, wait) {
          let timeout;
          return function(...args) {
              clearTimeout(timeout);
              timeout = setTimeout(() => func.apply(this, args), wait);
          };
      }

      function loadSurahs() {
          surahs.forEach((surah, index) => {
              const tr = document.createElement('tr');
              const selectHtml = `<select id=\"level-${index}\">
                                    <option value=\"\">اختر المستوى</option>
                                    <option value=\"1\">ضعيف</option>
                                    <option value=\"2\">متوسط</option>
                                    <option value=\"3\">جيد</option>
                                    <option value=\"4\">ممتاز</option>
                                </select>`;
              tr.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${surah}</td>
                  <td>${selectHtml}</td>
                  <td contenteditable=\"true\" id=\"review1-${index}\"></td>
                  <td contenteditable=\"true\" id=\"review2-${index}\"></td>
                  <td contenteditable=\"true\" id=\"review3-${index}\"></td>
              `;
              tbody.appendChild(tr);

              const select = tr.querySelector('select');
              select.addEventListener('change', () => {
                  saveState(index);
                  updateLevelStats();
              });

              for(let i = 3; i <= 5; i++) {
                  const cell = tr.cells[i];
                  cell.addEventListener('input', debounce(() => {
                      saveReviewDate(index, i - 2, cell);
                  }, 500));
              }
          });
          restoreState();
          updateLevelStats();
      }

      function saveState(index) {
          const select = document.getElementById(`level-${index}`);
          localStorage.setItem(`level-${index}`, select.value);
      }

      function saveReviewDate(index, col, element) {
          localStorage.setItem(`review-${index}-${col}`, element.textContent.trim());
      }

      function restoreState() {
          surahs.forEach((_, index) => {
              const level = localStorage.getItem(`level-${index}`);
              if(level) {
                  const select = document.getElementById(`level-${index}`);
                  select.value = level;
              }
              for(let col = 1; col <= 3; col++) {
                  const reviewDate = localStorage.getItem(`review-${index}-${col}`);
                  if(reviewDate) {
                      const row = tbody.children[index];
                      row.cells[col + 2].textContent = reviewDate;
                  }
              }
          });
      }

      function updateLevelStats() {
          let counts = { '1': 0, '2': 0, '3': 0, '4': 0 };
          let total = 0;
          for(let row of tbody.children) {
              const select = row.querySelector('select');
              if(select && select.value && counts.hasOwnProperty(select.value)) {
                  counts[select.value]++;
                  total++;
              }
          }
          if(total === 0) {
              levelStatsContainer.innerHTML = '<em>لم يتم تعيين مستويات الحفظ بعد.</em>';
              return;
          }

          const levelColors = { '1': '#e74c3c', '2': '#f39c12', '3': '#2980b9', '4': '#27ae60' };
          const levelNames = { '1': 'ضعيف', '2': 'متوسط', '3': 'جيد', '4': 'ممتاز' };

          let html = '';
          for(let level of ['1', '2', '3', '4']) {
              const percent = ((counts[level] / total) * 100).toFixed(1);
              const countText = counts[level] === 1 ? `1 سورة` : `${counts[level]} سور`;
              html += `<div class=\"level-row\">
                  <span class=\"level-label\">${levelNames[level]}</span>
                  <div class=\"level-percentage\">
                      <div class=\"level-fill\" style=\"background-color: ${levelColors[level]}; width: 0%;\">${percent}%</div>
                  </div>
                  <span class=\"level-count\">${countText}</span>
              </div>`;
          }
          levelStatsContainer.innerHTML = html;
          const fills = levelStatsContainer.querySelectorAll('.level-fill');
          fills.forEach((fill, i) => {
              const widthPercent = fill.textContent;
              setTimeout(() => {
                  fill.style.width = widthPercent;
              }, i * 200);
          });
      }

      async function saveToSupabase() {
          let userData = {};
          for(let i=0; i<surahs.length; i++) {
              userData[i] = {
                  level: document.getElementById(`level-${i}`).value,
                  review1: document.getElementById(`review1-${i}`).textContent,
                  review2: document.getElementById(`review2-${i}`).textContent,
                  review3: document.getElementById(`review3-${i}`).textContent
              };
          }
          const { data, error } = await supabase.from('quran_review').upsert([{
              id: 'user1',
              data: userData
          }], { onConflict: 'id' });
          if (error) {
              console.error(error);
              alert('حدث خطأ في الحفظ');
          } else {
              alert('تم الحفظ على السحابة');
          }
      }

      async function loadFromSupabase() {
          const { data, error } = await supabase.from('quran_review').select('*').eq('id', 'user1');
          if (error) {
              console.error(error);
              return;
          }
          if (data.length > 0) {
              const userData = data[0].data;
              Object.keys(userData).forEach(i => {
                  const d = userData[i];
                  document.getElementById(`level-${i}`).value = d.level || '';
                  document.getElementById(`review1-${i}`).textContent = d.review1 || '';
                  document.getElementById(`review2-${i}`).textContent = d.review2 || '';
                  document.getElementById(`review3-${i}`).textContent = d.review3 || '';
              });
              updateLevelStats();
              alert('تم الاسترجاع من السحابة');
          }
      }

      window.onload = () => {
          loadSurahs();
          loadFromSupabase();
      };

      function addColumn() {
          const header = document.querySelector('#quranTable thead tr');
          const newColumnCount = header.cells.length - 2;
          const newHeader = document.createElement('th');
          newHeader.textContent = `تاريخ المراجعة ${newColumnCount}`;
          header.appendChild(newHeader);
          document.querySelectorAll('#quranTable tbody tr').forEach((tr, index) => {
              const newCell = document.createElement('td');
              newCell.contentEditable = true;
              newCell.addEventListener('input', debounce(() => {
                  saveReviewDate(index, newColumnCount, newCell);
              }, 500));
              tr.appendChild(newCell);
          });
      }
    </script>
</body>
</html>
